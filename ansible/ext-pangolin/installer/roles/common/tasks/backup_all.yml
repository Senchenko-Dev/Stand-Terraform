- name: Ð¡reate OS user and group postgres for all nodes
  block:

    - name: create postgres group
      group:
        name: postgres
        state: present

    - name: create postgres user on etcd host
      user:
        name: postgres
        group: postgres
        comment: User for PostgreSQL database
  
  become: true
        
- name: Delete previous backups and ensure {{ backup_root_dir }}
  block:

    - name: get list folders to remove
      find:
        path: "{{ backup_main_dir }}"
        file_type: directory
        excludes: "{{ pg_current_version }}"
      register: del_old_folders

    - name: delete previous backup folders
      file:
        path: "{{ item.path }}"
        state: absent
      with_items: "{{ del_old_folders.files }}"

    - name: ensure {{ backup_root_dir }}
      file:
        path: "{{ backup_root_dir }}/{{ service_path_dir }}"
        state: directory
        owner: postgres
        group: postgres
        mode: 0700

  become: true

- name: Backup common files
  include_tasks: backup.yml

- name: Backup all
  block:
    
    - name: backup postgresql se
      include_role:
        name: postgresql
        tasks_from: backup
      when: postgres

    - name: backup patroni
      include_role:
        name: patroni
        tasks_from: backup
      when: is_patroni_exists

    - name: backup HAProxy
      include_role:
        name: HAProxy
        tasks_from: backup
      when: haproxy

    - name: backup pgbouncer
      include_role:
        name: pgbouncer
        tasks_from: backup
      when: pgbouncer

    - name: backup doc
      include_role:
        name: doc
        tasks_from: backup
      when: documentations

    - name: backup src scripts
      include_role:
        name: SRC
        tasks_from: backup
      when: SRC

    - name: backup rsyslog config
      include_role:
        name: rsyslog
        tasks_from: backup
      when: rsyslog

    - name: backup pg_auth_reencrypt
      include_role:
        name: pg_auth_reencrypt
        tasks_from: backup

  become: true
  when: inventory_hostname != 'etcd'

- name: Backup etcd
  include_role:
    name: etcd
    tasks_from: backup
  when: etcd