- name: Set DB for install pg_profile
  set_fact:
    _cfgpgprofile_install_db: "{% if action_type == 'install' %}{{ db_name }}\
                              {% else %}{{ _cfgpgprofile_selected_db_update }}{% endif %}"
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ groups['postgres_nodes'] }}"

- name: Add and configure profile_tuz db user
  block:

    - name: add and configure profile_tuz db user on master
      include_role:
        name: postgresql
        tasks_from: add_and_configure_db_user_with_enc_space.yml
      vars:
        _addcfgdbuserenc_pghome: "{{ PGHOME }}"
        _addcfgdbuserenc_user: profile_tuz
        _addcfgdbuserenc_dbnames: ["postgres", "{{ _cfgpgprofile_install_db }}"]
        _addcfgdbuserenc_input_user_pass: '{% if pg_profile_tuz_pass is defined and pg_profile_tuz_pass|length > 0 %}{{ pg_profile_tuz_pass }}{% endif %}'
        _addcfgdbuserenc_privs: 'NOINHERIT'

    - name: save profile_tuz user pass
      set_fact:
        pg_profile_tuz_pass: "{{ _addcfgdbuserenc_output_user_pass }}"
      delegate_to: "{{ item }}"
      delegate_facts: true
      loop: "{{ groups['postgres_nodes'] }}"

  no_log: "{{ nolog }}"

- name: Create dblink, plpgsql, pg_profile extensions, create pgse_profile schema and configure it
  block:

    - name: create dblink, plpgsql extensions
      postgresql_ext:
        name: "{{ item.ext }}"
        schema: "{{ item.sch }}"
        db: "{{ _cfgpgprofile_install_db }}"
        port: "{{ ports.pg }}"
      with_items:
        - { ext: "dblink",     sch: "ext" }
        - { ext: "plpgsql",    sch: "pg_catalog" }

    - name: create pgse_profile schema
      postgresql_schema:
        db: "{{ _cfgpgprofile_install_db }}"
        name: pgse_profile
        owner: "{{ db_admin }}"
        port: "{{ ports.pg }}"

    - name: add description for pgse_profile schema
      postgresql_query:
        port: "{{ ports.pg }}"
        db: "{{ _cfgpgprofile_install_db }}"
        query: "COMMENT ON SCHEMA pgse_profile IS 'Schema for pgse_profile extension only';"

    - name: create pg_profile extensions
      postgresql_ext:
        name: pg_profile
        schema: pgse_profile
        db: "{{ _cfgpgprofile_install_db }}"
        port: "{{ ports.pg }}"
      register: _cfgpgprofile_pg_profile_ext_installed

    - name: configure pg_profile
      block:

      - name: get schema of installed pg_stat_statements extension
        postgresql_query:
          port: "{{ ports.pg }}"
          db: postgres
          query: "SELECT nspname FROM pg_catalog.pg_extension ex \
                  JOIN pg_namespace ns ON ex.extnamespace =ns.oid \
                  WHERE ex.extname='pg_stat_statements';"
        register: _cfgpgprofile_pgss_schema

      - name: grant privs to profile_tuz
        postgresql_query:
          query: "{{ item }}"
          port: "{{ ports.pg }}"
          db: "{{ _cfgpgprofile_install_db }}"
        with_items:
          - "GRANT USAGE ON SCHEMA {{ _cfgpgprofile_pgss_schema.query_result[0].nspname }}, pgse_profile, ext TO profile_tuz"
          - "GRANT pg_read_all_stats TO profile_tuz"
          - "GRANT EXECUTE ON FUNCTION {{ _cfgpgprofile_pgss_schema.query_result[0].nspname }}.pg_stat_statements_reset TO profile_tuz"
          - "GRANT all ON all TABLES IN SCHEMA {{ _cfgpgprofile_pgss_schema.query_result[0].nspname }}, ext TO profile_tuz"
          - "GRANT SELECT, USAGE ON all sequences IN SCHEMA {{ _cfgpgprofile_pgss_schema.query_result[0].nspname }}, ext TO profile_tuz"
          - "GRANT EXECUTE ON all functions in SCHEMA {{ _cfgpgprofile_pgss_schema.query_result[0].nspname }}, ext TO profile_tuz"
          - "GRANT all ON all tables in SCHEMA pgse_profile TO profile_tuz"
          - "GRANT SELECT, USAGE ON all sequences IN SCHEMA pgse_profile TO profile_tuz"
          - "GRANT EXECUTE ON all functions IN SCHEMA pgse_profile TO profile_tuz"
          - "GRANT USAGE ON TYPE ext.dblink_pkey_results TO profile_tuz"

      - name: set cron setting command
        set_fact:
          _cfgpgprofile_cron_cmd: "[ \"SELECT pgse_profile.drop_server('local');\",
                                    \"SELECT pgse_profile.create_server('master', 'dbname={{ _cfgpgprofile_install_db }} host={{ hostvars.master.ansible_fqdn }} port={{ ports.pg }} user=profile_tuz');\",
                                    {% if installation_type == 'cluster' %}\
                                    \"SELECT pgse_profile.create_server('replica', 'dbname={{ _cfgpgprofile_install_db }} host={{ hostvars.replica.ansible_fqdn }} port={{ ports.pg }} user=profile_tuz');\"\
                                    {% endif %} ]"

      - name: grant privs to profile_tuz
        postgresql_query:
          query: "{{ item }}"
          port: "{{ ports.pg }}"
          db: "{{ _cfgpgprofile_install_db }}"
        register: _cfgpgprofile_create_server
        with_items: '{{ _cfgpgprofile_cron_cmd }}'

      - name: create and configure cron job for pg_profile
        block:

          - name: create cron job for pg_profile
            postgresql_query:
              query: "SELECT cron.schedule('{{ pg_profile.stats_periods }}', 'SELECT pgse_profile.take_sample()');"
              session_role: db_admin
              db: "postgres"
              port: "{{ ports.pg }}"
            register: result_cron_cfg

          - name: configure cron job for pg_profile
            postgresql_query:
              query: "UPDATE cron.job SET database='{{ _cfgpgprofile_install_db }}', username='profile_tuz' \
                        WHERE jobid='{{ result_cron_cfg.query_result[0].schedule }}';"
              port: "{{ ports.pg }}"

        when: action_type != 'update_major'

      - name: grant privs to as_admin and as_admin_read
        postgresql_query:
          query: "{{ item }}"
          port: "{{ ports.pg }}"
          db: "{{ _cfgpgprofile_install_db }}"
        with_items:
          - GRANT USAGE ON SCHEMA pgse_profile TO "as_admin", "as_admin_read";
          - GRANT SELECT ON ALL TABLES IN SCHEMA pgse_profile TO "as_admin", "as_admin_read";
          - GRANT USAGE ON ALL SEQUENCES IN SCHEMA pgse_profile TO "as_admin", "as_admin_read";
          - GRANT USAGE ON TYPE ext.dblink_pkey_results TO "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.check_stmt_all_setting(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.check_stmt_cnt(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.cluster_stats(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.cluster_stats_diff_htbl(jsonb, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.cluster_stats_htbl(jsonb, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.cluster_stats_reset(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.cluster_stats_reset_diff_htbl(jsonb, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.cluster_stats_reset_htbl(jsonb, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.collect_obj_stats(jsonb, integer, integer, text, boolean, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.collect_pg_stat_statements_stats(jsonb, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.collect_queries(oid, oid, bigint) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.create_baseline(character varying, tstzrange, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.create_baseline(name, character varying, tstzrange, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.create_baseline(character varying, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.create_baseline(name, character varying, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.create_server(name, text, boolean, integer, text) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.dbstats(integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.dbstats_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.dbstats_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.dbstats_reset(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.dbstats_reset_diff_htbl(jsonb, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.dbstats_reset_htbl(jsonb, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.dbstats_sessions(integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.dbstats_sessions_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.dbstats_sessions_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.disable_server(name) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.drop_baseline(character varying) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.drop_baseline(name, character varying) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.drop_server(name) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.enable_server(name) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.export_data(name, integer, integer, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.func_top_calls_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.func_top_calls_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.func_top_time_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.func_top_time_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.func_top_trg_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.func_top_trg_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_baseline_samples(integer, character varying) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_connstr(integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(character varying, character varying, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(name, character varying, character varying, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(name, character varying, tstzrange, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(name, tstzrange, character varying, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(name, tstzrange, tstzrange, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(integer, integer, character varying, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(character varying, integer, integer, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(name, integer, integer, character varying, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(name, character varying, integer, integer, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(integer, integer, integer, integer, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(name, integer, integer, integer, integer, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_diffreport(integer, integer, integer, integer, integer, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_report(character varying, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_report(tstzrange, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_report(name, character varying, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_report(name, tstzrange, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_report(integer, integer, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_report(integer, tstzrange, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_report(name, integer, integer, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_report(integer, integer, integer, text, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_report_latest(name) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_sampleids_by_timerange(integer, tstzrange) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_server_by_name(name) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.get_sized_bounds(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.import_data(regclass) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.index_size_failures(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.ix_top_fetch_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.ix_top_fetch_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.ix_top_io_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.ix_top_io_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.ix_unused_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.jsonb_replace(jsonb, jsonb) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.keep_baseline(character varying, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.keep_baseline(name, character varying, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.nodata_wrapper(text) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_functions(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_planning_times(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_rusage(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_rusage_planstats(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_sessionstats(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_statstatements(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_stmt_wal_bytes(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_tablegrowth(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_tablesizes(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_trg_functions(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.profile_checkavail_walstats(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.rename_server(name, name) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.report_queries(jsonb, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.sample_dbobj_delta(jsonb, integer, integer, integer, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.set_server_connstr(name, text) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.set_server_db_exclude(name, name[]) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.set_server_description(name, text) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.set_server_max_sample_age(name, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.set_server_size_sampling(name, time with time zone, interval, interval, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.settings_and_changes(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.settings_and_changes_diff_htbl(jsonb, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.settings_and_changes_htbl(jsonb, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.show_baselines(name) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.show_samples(integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.show_samples(name, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.show_servers() to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.show_servers_size_sampling() to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.snapshot() to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.snapshot(name) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.statements_stats(integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.statements_stats_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.statements_stats_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.table_size_failures(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.tablespace_stats(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.tablespaces_stats_diff_htbl(jsonb, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.tablespaces_stats_htbl(jsonb, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.tbl_top_dead_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.tbl_top_fetch_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.tbl_top_fetch_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.tbl_top_io_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.tbl_top_io_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.tbl_top_mods_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_analyzed_tables_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_analyzed_tables_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_cpu_time_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_cpu_time_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_dml_tables_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_dml_tables_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_elapsed_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_elapsed_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_exec_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_exec_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_exec_time_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_exec_time_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_functions(integer, integer, integer, boolean) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_growth_indexes_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_growth_indexes_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_growth_tables_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_growth_tables_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_indexes(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_io_filesystem_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_io_filesystem_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_io_indexes(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_io_tables(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_iowait_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_iowait_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_kcache_statements(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_plan_time_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_plan_time_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_scan_tables_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_scan_tables_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_shared_blks_fetched_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_shared_blks_fetched_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_shared_dirtied_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_shared_dirtied_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_shared_reads_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_shared_reads_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_shared_written_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_shared_written_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_statements(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_tables(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_temp_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_temp_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_upd_vac_tables_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_upd_vac_tables_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_vacuumed_indexes_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_vacuumed_indexes_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_vacuumed_tables_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_vacuumed_tables_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_wal_size_diff_htbl(jsonb, integer, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.top_wal_size_htbl(jsonb, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.wal_stats(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.wal_stats_diff_htbl(jsonb, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.wal_stats_htbl(jsonb, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.wal_stats_reset(integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.wal_stats_reset_diff_htbl(jsonb, integer, integer, integer, integer, integer) to "as_admin", "as_admin_read";
          - GRANT EXECUTE ON FUNCTION pgse_profile.wal_stats_reset_htbl(jsonb, integer, integer, integer) to "as_admin", "as_admin_read";

      when: "_cfgpgprofile_pg_profile_ext_installed.changed"

  environment: "{{ db_connection_args }}"
  become: true
  become_user: postgres
  when: ansible_fqdn == current_master