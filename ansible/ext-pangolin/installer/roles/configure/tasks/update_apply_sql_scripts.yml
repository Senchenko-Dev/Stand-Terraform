- name: Apply sql scripts
  block:

    - name: copy search_path script
      template:
        src: search_path_ext.sql.j2
        dest: "{{ REMOTE_TMP }}/search_path_ext.sql"
        owner: postgres
        group: postgres
        mode: 0644
      when: search_path_ext is defined

    - name: copy get_role_passwd script
      copy:
        src: "get_role_passwd.sql"
        dest: "{{ REMOTE_TMP }}/get_role_passwd.sql"
        owner: postgres
        group: postgres
        mode: 0644
      when: monitoring_php_script is defined

    - name: copy update_drop_roles script
      copy:
        src: "update_drop_roles.sql"
        dest: "{{ REMOTE_TMP }}/update_drop_roles.sql"
        owner: postgres
        group: postgres
        mode: 0644
      when: drop_roles is defined

    - name: apply get_role_passwd script
      postgresql_query:
        port: "{{ ports.pg }}"
        path_to_script: "{{ REMOTE_TMP }}/get_role_passwd.sql"
      when: monitoring_php_script is defined

    - name: apply search_path script
      postgresql_query:
        port: "{{ ports.pg }}"
        path_to_script: "{{ REMOTE_TMP }}/search_path_ext.sql"
      when: search_path_ext is defined

    - name: apply update_drop_roles script
      postgresql_query:
        port: "{{ ports.pg }}"
        path_to_script: "{{ REMOTE_TMP }}/update_drop_roles.sql"
      when: drop_roles is defined

    - name: clean remote tmp
      file:
        state: absent
        path: "{{ item }}"
      with_items:
        - "{{ REMOTE_TMP }}/search_path_ext.sql"
        - "{{ REMOTE_TMP }}/get_role_passwd.sql"
        - "{{ REMOTE_TMP }}/update_drop_roles.sql"

  environment: "{{ db_connection_args }}"
  become: true
  become_user: postgres
  when: ansible_fqdn == current_master