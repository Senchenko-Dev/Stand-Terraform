- name: Set python interpretator
  set_fact:
    ansible_python_interpreter: '{{ python.global_bin_2 }}'

- name: Recovery pgbouncer
  block:

    - name: gather services facts
      service_facts:

    - name: stop pgbouncer service
      service:
        name: pgbouncer
        state: stopped
      when: ansible_facts.services['pgbouncer.service'].state == 'running'

    - name: return pgbouncer files to previous state
      copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        remote_src: true
        directory_mode: yes
      with_items:
        - { src: "{{ backup.pgbouncer }}{{ pgbouncer_files.conf_dir }}/userlist.txt",  dest: "{{ pgbouncer_files.conf_dir }}/", owner: postgres, group: postgres }
        - { src: "{{ backup_root_dir }}{{ service_path_dir }}/pgbouncer.service",      dest: "{{ service_path_dir }}/",         owner: root,     group: root }
        - { src: "{{ backup_root_dir }}{{ logrorate_dir }}/pgbouncer",                 dest: "{{ logrorate_dir }}/",            owner: root,     group: root }
        - { src: "{{ backup.pgbouncer }}{{ pgbouncer_files.bin_path }}",               dest: "{{ bin_dir }}/",                  owner: root,     group: root }
        - { src: "{{ backup.pgbouncer }}{{ user_share_dir }}/doc",                     dest: "{{ user_share_dir }}/",           owner: root,     group: root }
        - { src: "{{ backup.pgbouncer }}{{ user_share_dir }}/man/man1/pgbouncer.1",    dest: "{{ user_share_dir }}/man/man1/",  owner: root,     group: root }
        - { src: "{{ backup.pgbouncer }}{{ user_share_dir }}/man/man5/pgbouncer.5",    dest: "{{ user_share_dir }}/man/man5/",  owner: root,     group: root }
        - { src: "{{ backup.pgbouncer }}{{ pgbouncer_files.conf_dir }}/pgbouncer.ini", dest: "{{ pgbouncer_files.conf_dir }}/", owner: postgres, group: postgres }

    - name: restarted systemd and start service
      systemd:
        name: pgbouncer
        state: restarted
        daemon_reload: yes
        enabled: yes

    - name: wait when pgbouncer service to open the port
      wait_for:
        port: "{{ ports.pgbouncer }}"
        host: "{{ ansible_fqdn }}"
        state: started
        timeout: 10
        delay: 5

  become: true

- name: recovery confd
  block:

    - name: stop confd service
      service:
        name: confd
        state: stopped
      when: "'confd.service' in ansible_facts.services"

    - name: revert confd files
      synchronize:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
      delegate_to: "{{ inventory_hostname }}"
      become_user: root
      with_items:
        - { src: '{{ backup.confd }}{{ confd_files.path_dir }}/', dest: '{{ confd_files.path_dir }}' }
        - { src: '{{ backup.confd }}{{ confd_files.conf_dir }}/', dest: '{{ confd_files.conf_dir }}' }
        - { src: '{{ backup.confd }}{{ confd_files.service_file }}', dest: '{{ service_path_dir }}' }

    - name: daemon reload of systemctl services
      systemd:
        daemon_reload: yes

    - name: start confd service and enable
      systemd:
        name: confd
        state: started
        daemon_reload: yes
        enabled: yes
      register: result
      until: result.status.ActiveState == 'active'
      retries: 6
      delay: 10

  become_user: root
  become: true
  when: confd