- name: Common task for master, replica and haproxy
  block:
  
    - name: ensure {{ backup.haproxy }} directory exist
      file:
        path: "{{ item.src }}"
        state: "{{ item.state }}"
        mode: 0750
      with_items:
        - { src: "{{ backup.haproxy }}",                                state: "absent" }
        - { src: "{{ backup.haproxy }}{{ haproxy_files.socket_dir }}/", state: "directory" }
        - { src: "{{ backup.haproxy }}{{ haproxy_files.conf_dir }}/",   state: "directory" }

    - name: backup haproxy files
      copy:
        src: "{{ haproxy_files.conf_dir }}/haproxy.cfg"
        dest: "{{ backup.haproxy }}{{ haproxy_files.conf_dir }}/haproxy.cfg"
        remote_src: yes
        owner: postgres
        group: postgres
        mode: 0600
      
    - name: download the HAProxy package but do not install it
      yum:
        name:
          - "haproxy-{{ ansible_facts.packages['haproxy'][0].version }}"
        state: latest
        download_only: yes
        download_dir: "{{ backup.haproxy }}/"
        allow_downgrade: yes
      when: ansible_os_family == "RedHat"
    
    - name: download previous etcd package but do not install it
      shell: "{{ item }}"
      with_items:
        - "apt-get install -dy --reinstall haproxy={{ ansible_facts.packages['haproxy'][0].version }}"
        - "cp /var/cache/apt/archives/haproxy* {{ backup.haproxy }}"
      when: ansible_os_family == "Altlinux"

  become: true