- name: Read certificates
  block:

    - name: set python interpretator
      set_fact:
        ansible_python_interpreter: '{{ python.postgresql_venv }}/bin/python3'
      run_once: true

    - name: get crt info for '{{ common_name }}'
      openssl_certificate_info:
        path: "{{ crt_file }}"
      register: crt_result

    - name: get private key info for '{{ common_name }}'
      openssl_privatekey_info:
        path: "{{ key_file }}"
      register: key_result

  become: true
  no_log: "{{ nolog }}"

- name: Check public key for '{{ common_name }}'
  assert:
    that: crt_result.public_key == key_result.public_key
    fail_msg: "{{ message_installer.fails.check_public_cert.format(crt_file, key_file) }}"

- name: Check subject of certificate for '{{ common_name }}'
  assert:
    that: "'{{ crt_result.subject.commonName }}' == '{{ common_name }}'"
    fail_msg: "{{ message_installer.fails.check_subject_cert.format(crt_file, common_name) }}"

- name: Check if certificate for '{{ common_name }}' not expired
  assert:
    that: not crt_result.expired
    fail_msg: "{{ message_installer.fails.check_date_cert.format(crt_file) }}"