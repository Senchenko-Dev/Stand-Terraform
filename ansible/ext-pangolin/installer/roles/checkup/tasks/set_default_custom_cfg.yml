- name: Set default pg_profile and other monitoring and diagnostic extension params
  block:

    - name: set default pg_profile status value
      set_fact:
        pg_profile_def_status: true

    - name: set default pg_profile params
      set_fact:
        pg_profile:
          is_enable: "{% if pg_profile.is_enable is not defined %}\
                        {{ pg_profile_def_status }}\
                      {% else %}\
                        {{ pg_profile.is_enable }}\
                      {% endif %}"
          topn: "{% if pg_profile.topn is not defined %}\
                   20\
                 {% else %}\
                   {{ pg_profile.topn }}\
                 {% endif %}"
          max_sample_age: "{% if pg_profile.max_sample_age is not defined %}\
                             7\
                           {% else %}\
                             {{ pg_profile.max_sample_age }}\
                           {% endif %}"
          track_sample_timings: "{% if pg_profile.track_sample_timings is not defined %}\
                                   off\
                                 {% else %}\
                                   {{ pg_profile.track_sample_timings }}\
                                 {% endif %}"
          stats_periods: "{% if pg_profile.stats_periods is not defined %}\
                            0,30 * * * *\
                          {% else %}\
                            {{ pg_profile.stats_periods }}\
                          {% endif %}"

    - name: set pg stat other params
      set_fact:
        pg_stat_track_activities: "{% if pg_stat_track_activities is not defined %}\
                                     on\
                                   {% else %}\
                                     {{ pg_stat_track_activities }}\
                                   {% endif %}"
        pg_stat_track_counts: "{% if pg_stat_track_counts is not defined %}\
                                 on\
                               {% else %}\
                                 {{ pg_stat_track_counts }}\
                               {% endif %}"
        pg_stat_track_io_timing: "{% if pg_stat_track_io_timing is not defined %}\
                                    on\
                                  {% else %}\
                                    {{ pg_stat_track_io_timing }}\
                                  {% endif %}"
        pg_stat_track_functions: "{% if pg_stat_track_functions is not defined %}\
                                    none\
                                  {% else %}\
                                    {{ pg_stat_track_functions }}\
                                  {% endif %}"
        pg_stat_statements_track: "{% if pg_stat_statements_track is not defined %}\
                                     top\
                                   {% else %}\
                                     {{ pg_stat_statements_track }}\
                                   {% endif %}"
        pg_stat_statements_max: "{% if pg_stat_statements_max is not defined %}\
                                     5000\
                                   {% else %}\
                                     {{ pg_stat_statements_max }}\
                                   {% endif %}"

    - name: set default pg_stat_kcache params
      set_fact:
        pg_stat_kcache_is_enable: "{% if pg_stat_kcache_is_enable is not defined %}\
                                    True\
                                  {% else %}\
                                    {{ pg_stat_kcache_is_enable }}\
                                  {% endif %}"
        pg_stat_kcache_linux_hz: "{{ ( pg_stat_kcache_linux_hz ) | default('-1', True) }}"

    - name: set default relnblocks params
      set_fact:
        relnblocks_enable: "{{ ( relnblocks_enable ) | default('on', True) }}"
        relnblocks_hash_max_size: "{{ ( relnblocks_hash_max_size ) | default('1000000', True) }}"
        relnblocks_hash_init_size: "{{ ( relnblocks_hash_init_size ) | default('1024', True) }}"
        relnblocks_hash_init_db: "{{ ( relnblocks_hash_init_db ) | default('20', True) }}"
        relnblocks_hash_max_db: "{{ ( relnblocks_hash_max_db ) | default('1024', True) }}"

    - name: set performance insights params
      set_fact:
        performance_insights:
          is_enable: "{% if performance_insights.is_enable is not defined %}\
                        False\
                      {% else %}\
                        {{ performance_insights.is_enable }}\
                      {% endif %}"
          masking: "{{ ( performance_insights.masking ) | default('True', True) }}"
          sampling_enable: "{{ ( performance_insights.sampling_enable ) | default('True', True) }}"
          sampling_period: "{{ ( performance_insights.sampling_period ) | default('5s', True) }}"
          num_samples_in_ram: "{{ ( performance_insights.num_samples_in_ram ) | default('12', True) }}"
          num_samples_in_files: "{{ ( performance_insights.num_samples_in_files ) | default('86400', True) }}"

- name: Set default password policy params
  block:

    - name: set default boolean params
      set_fact:
        is_pp_temp_tuz_password: true
        pp_transport_password_mark_automatic: false

    - name: set default password policy params
      set_fact:
        password_policy_params:
          is_temp_tuz_password: "{% if password_policy_params.is_temp_tuz_password is not defined %}\
                                    {{ is_pp_temp_tuz_password }}\
                                 {% else %}\
                                    {{ password_policy_params.is_temp_tuz_password }}\
                                 {% endif %}"
          transport_password_mark_automatic: "{% if password_policy_params.transport_password_mark_automatic is not defined %}\
                                                {{ pp_transport_password_mark_automatic }}\
                                              {% else %}\
                                                {{ password_policy_params.transport_password_mark_automatic }}\
                                              {% endif %}"
          transport_password_life_time: "{% if password_policy_params.transport_password_life_time is not defined %}\
                                           0\
                                         {% else %}\
                                           {{ password_policy_params.transport_password_life_time }}\
                                         {% endif %}"
          deny_default: "{% if password_policy_params.deny_default is not defined %}\
                           off\
                         {% else %}\
                           {{ password_policy_params.deny_default }}\
                         {% endif %}"
          reuse_time: "{% if password_policy_params.reuse_time is not defined %}\
                         365 days\
                       {% else %}\
                         {{ password_policy_params.reuse_time }}\
                       {% endif %}"
          in_history: "{% if password_policy_params.in_history is not defined %}\
                         4\
                       {% else %}\
                         {{ password_policy_params.in_history }}\
                       {% endif %}"
          max_age: "{% if password_policy_params.max_age is not defined %}\
                      0\
                    {% else %}\
                      {{ password_policy_params.max_age }}\
                    {% endif %}"
          min_age: "{% if password_policy_params.min_age is not defined %}\
                      0\
                    {% else %}\
                      {{ password_policy_params.min_age }}\
                    {% endif %}"
          grace_login_limit: "{% if password_policy_params.grace_login_limit is not defined %}\
                                0\
                              {% else %}\
                                {{ password_policy_params.grace_login_limit }}\
                              {% endif %}"
          grace_login_time_limit: "{% if password_policy_params.grace_login_time_limit is not defined %}\
                                     3 days\
                                   {% else %}\
                                     {{ password_policy_params.grace_login_time_limit }}\
                                   {% endif %}"
          expire_warning: "{% if password_policy_params.expire_warning is not defined %}\
                             7 days\
                           {% else %}\
                             {{ password_policy_params.expire_warning }}\
                           {% endif %}"
          lockout: "{% if password_policy_params.lockout is not defined %}\
                      on\
                    {% else %}\
                      {{ password_policy_params.lockout }}\
                    {% endif %}"
          lockout_duration: "{% if password_policy_params.lockout_duration is not defined %}\
                               24 hours\
                             {% else %}\
                               {{ password_policy_params.lockout_duration }}\
                             {% endif %}"
          max_failure: "{% if password_policy_params.max_failure is not defined %}\
                          6\
                        {% else %}\
                          {{ password_policy_params.max_failure }}\
                        {% endif %}"
          failure_count_interval: "{% if password_policy_params.failure_count_interval is not defined %}\
                                     0\
                                   {% else %}\
                                     {{ password_policy_params.failure_count_interval }}\
                                   {% endif %}"
          check_syntax: "{% if password_policy_params.check_syntax is not defined %}\
                           on\
                         {% else %}\
                           {{ password_policy_params.check_syntax }}\
                         {% endif %}"
          min_length: "{% if password_policy_params.min_length is not defined %}\
                         16\
                       {% else %}\
                         {{ password_policy_params.min_length }}\
                       {% endif %}"
          illegal_values: "{% if password_policy_params.illegal_values is not defined %}\
                             on\
                           {% else %}\
                             {{ password_policy_params.illegal_values }}\
                           {% endif %}"
          alpha_numeric: "{% if password_policy_params.alpha_numeric is not defined %}\
                            3\
                          {% else %}\
                            {{ password_policy_params.alpha_numeric }}\
                          {% endif %}"
          min_alpha_chars: "{% if password_policy_params.min_alpha_chars is not defined %}\
                              0\
                            {% else %}\
                              {{ password_policy_params.min_alpha_chars }}\
                            {% endif %}"
          min_special_chars: "{% if password_policy_params.min_special_chars is not defined %}\
                                1\
                              {% else %}\
                                {{ password_policy_params.min_special_chars }}\
                              {% endif %}"
          min_uppercase: "{% if password_policy_params.min_uppercase is not defined %}\
                            1\
                          {% else %}\
                            {{ password_policy_params.min_uppercase }}\
                          {% endif %}"
          min_lowercase: "{% if password_policy_params.min_lowercase is not defined %}\
                            0\
                          {% else %}\
                            {{ password_policy_params.min_lowercase }}\
                          {% endif %}"
          max_rpt_chars: "{% if password_policy_params.max_rpt_chars is not defined %}\
                            0\
                          {% else %}\
                            {{ password_policy_params.max_rpt_chars }}\
                          {% endif %}"
          track_login: "{% if password_policy_params.track_login is not defined %}\
                          off\
                        {% else %}\
                          {{ password_policy_params.track_login }}\
                        {% endif %}"
          max_inactivity: "{% if password_policy_params.max_inactivity is not defined %}\
                             0\
                           {% else %}\
                             {{ password_policy_params.max_inactivity }}\
                           {% endif %}"
          use_password_strength_estimator: "{% if password_policy_params.use_password_strength_estimator is not defined %}\
                                              on\
                                            {% else %}\
                                              {{ password_policy_params.use_password_strength_estimator }}\
                                            {% endif %}"
          password_strength_estimator_score: "{% if password_policy_params.password_strength_estimator_score is not defined %}\
                                                3\
                                              {% else %}\
                                                {{ password_policy_params.password_strength_estimator_score }}\
                                              {% endif %}"
          deduplicate_ssl_no_ssl_fail_auth_attepmts: "{% if password_policy_params.deduplicate_ssl_no_ssl_fail_auth_attepmts is not defined %}\
                                                        on\
                                                      {% else %}\
                                                        {{ password_policy_params.deduplicate_ssl_no_ssl_fail_auth_attepmts }}\
                                                      {% endif %}"
          allow_hashed_password: "{% if password_policy_params.allow_hashed_password is not defined %}\
                                    on\
                                  {% else %}\
                                    {{ password_policy_params.allow_hashed_password }}\
                                  {% endif %}"

- name: Enable ssl between components
  set_fact:
    ssl_mode: true
  when: ssl_mode is not defined

- name: Set default component configuration settings
  set_fact:
    pg_synchronous_mode: "{{ ( pg_synchronous_mode ) | default('True', True) }}"
    pg_synchronous_mode_strict: "{{ ( pg_synchronous_mode_strict ) | default('False', True) }}"
    etcd_timeout: "{{ ( etcd_timeout ) | default('5000', True) }}"
    etcd_interval: "{{ ( etcd_interval ) | default('1000', True) }}"
    log_prefix: "{{ ( log_prefix ) | default('%t [%p]: [%l-1] app=%a,user=%u,db=%d,client=%h,type=%b ', True) }}"

- name: Set default scouting params
  block:

    - name: set default local backup params
      set_fact:
        local_backup_path: "{% if local_backup_path is not defined %}\
                              /pgarclogs\
                            {% else %}\
                              {{ local_backup_path }}\
                            {% endif %}"
        local_backup_coefficient: "{% if local_backup_coefficient is not defined %}\
                                     1\
                                   {% else %}\
                                     {{ local_backup_coefficient }}\
                                   {% endif %}"
        maximum_dbms_size_to_update: "{% if maximum_dbms_size_to_update is not defined %}\
                                        0\
                                      {% else %}\
                                        {{ maximum_dbms_size_to_update }}\
                                      {% endif %}"
        false_error_filter_for_data_schema: "{% if false_error_filter_for_data_schema is not defined %}\
                                               []\
                                             {% else %}\
                                               {{ false_error_filter_for_data_schema }}\
                                             {% endif %}"
        not_support_type_installed_configuration: "{% if not_support_type_installed_configuration is not defined %}\
                                               []\
                                             {% else %}\
                                               {{ not_support_type_installed_configuration }}\
                                             {% endif %}"

- name: Enable local backup with pg_probackup
  set_fact:
    is_inner_full_backup: "{% if action_type == 'update_major' %}true{% else %}false{% endif %}"
  run_once: true
  when: is_inner_full_backup is not defined

- name: Old PGDATA after major update don't remove by default
  set_fact:
    is_removed_old_pgdata: true
  when: is_removed_old_pgdata is not defined

- name: Set default sec_admin_default_auth
  set_fact:
    sec_admin_default_auth: "{{ ( sec_admin_default_auth ) | default('scram-sha-256', True) }}"

- name: Set default turn_on_or_update_psql_lockmon
  set_fact:
    turn_on_or_update_psql_lockmon: "{% if turn_on_or_update_psql_lockmon is not defined %}\
                     false\
                   {% else %}\
                     {{ turn_on_or_update_psql_lockmon }}\
                   {% endif %}"

- name: Set default enable_monitor_object_modification_date
  set_fact:
    pg_enable_monitor_object_modification_date: "{{ ( pg_enable_monitor_object_modification_date ) | default('on', True) }}"

- name: Set default object_modification_date_keep_interval
  set_fact:
    pg_object_modification_date_keep_interval: "{{ ( pg_object_modification_date_keep_interval ) | default('1 week', True) }}"

- name: Disable auth_reencrypt if auth_encrypt = false and auth_reencrypt is not defined
  set_fact:
    auth_reencrypt: false
  when: auth_reencrypt is not defined and auth_encrypt is defined and not auth_encrypt

- name: Enable auth encrypt
  set_fact:
    auth_encrypt: true
  when: auth_encrypt is not defined

- name: Enable auth reencrypt
  set_fact:
    auth_reencrypt: true
  when: auth_reencrypt is not defined

- name: Set default settings for merge configs
  set_fact:
    is_update_ldap_auth_methods: "{{ (is_update_ldap_auth_methods) | default(False, true) }}"
    auth_methods_control_map:
      md5: "{{ (auth_methods_control_map.md5) | default('scram-sha-256', true) }}"

- name: Set default other params
  set_fact:
    ROLES_EXPIRES_DATE: "{{ ( ROLES_EXPIRES_DATE ) | default('infinity', True) }}"

- name: Set default connection settings
  set_fact:
    ldap_server: "{{ ( ldap_server ) | default('srv-0-39.db.dev.sbt', True) }}"

- name: Enable configure '{{ db_admin }}', '{{ as_group }}', '{{ TUZ_group }}'
  set_fact:
    cfg_main_roles: "{{ ( cfg_main_roles ) | default(False, true) }}"
