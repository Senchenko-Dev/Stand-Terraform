#when we turn on etcd v3
- name: Turn off etcd v2 in config and restart etcd
  block:

    - name: turn off etcd v2 in etcd.conf
      lineinfile:
        name: "{{ etcd_files.conf_dir }}/etcd.conf"
        regexp: 'ETCD_ENABLE_V2='
        line: 'ETCD_ENABLE_V2= "false"'

    - name: restart service etcd
      systemd:
        name: etcd
        state: restarted
        daemon_reload: yes
        enabled: yes

    - name: check that etcd cluster is healthy after restart service
      shell: etcdctl --user=root:'{{ etcd_root_pass }}' --cluster=true endpoint health 2>&1
      environment:
        ETCDCTL_API: 3
      register: result
      until: result.stdout.find("is healthy") != -1
      retries: 10
      delay: 1
      no_log: "{{ nolog }}"

  become: true