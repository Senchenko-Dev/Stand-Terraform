- name: Define recovery available of Pangolin for minor
  set_fact:
    is_recovery_pangolin_minor: "{% if (update_errors.components.pg \
                                        or update_errors.types.patroni.finally \
                                        or update_errors.components.pgbouncer \
                                        or update_errors.components.haproxy) \
                                      and not (update_errors.components.pg \
                                               and update_errors.hosts.replica \
                                               and inventory_hostname == 'master') \
                                      and action_type == 'update_minor' %}\
                                      true\
                                  {% else %}\
                                      false\
                                  {% endif %}"

- name: Define recovery available of Pangolin for major
  set_fact:
    is_recovery_pangolin_major: "{% if (update_errors.components.pg \
                                        or update_errors.components.configuration \
                                        or update_errors.types.src.install_pg_probackup \
                                        or update_errors.components.pgbouncer \
                                        or update_errors.components.haproxy \
                                        or update_errors.types.patroni.finally \
                                        or update_errors.types.pg_auth_reencrypt.finally \
                                        or update_errors.components.finally \
                                        or update_errors.components.tests) \
                                      and not update_errors.types.pg_auth_reencrypt.check_and_stop \
                                      and action_type == 'update_major' %}\
                                      true\
                                  {% else %}\
                                      false\
                                  {% endif %}"

- name: Recovery Pangolin
  include_role:
    name: postgresql
    tasks_from: "{% if action_type == 'update_major' %}revert_major.yml{% else %}revert_minor.yml{% endif %}"
  when: "postgres \
         and inventory_hostname != 'etcd' \
         and (is_recovery_pangolin_minor \
              or is_recovery_pangolin_major)"